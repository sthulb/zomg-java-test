
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Utility">
      
      
        <meta name="author" content="Amazon Web Services">
      
      
        <link rel="canonical" href="https://docs.powertools.aws.dev/lambda-java/1.16.0/utilities/idempotency/">
      
      
        <link rel="prev" href="../../core/metrics/">
      
      
        <link rel="next" href="../parameters/">
      
      <link rel="icon" href="../../media/aws-logo-light.svg">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.4">
    
    
      
        <title>Idempotency - Powertools for AWS Lambda (Java)</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.9c788c91.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Ubuntu";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#terminology" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Powertools for AWS Lambda (Java)" class="md-header__button md-logo" aria-label="Powertools for AWS Lambda (Java)" data-md-component="logo">
      
  <img src="../../media/aws-logo-light.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Powertools for AWS Lambda (Java)
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Idempotency
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="teal"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/aws-powertools/powertools-lambda-java" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Powertools for AWS Lambda (Java)" class="md-nav__button md-logo" aria-label="Powertools for AWS Lambda (Java)" data-md-component="logo">
      
  <img src="../../media/aws-logo-light.svg" alt="logo">

    </a>
    Powertools for AWS Lambda (Java)
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/aws-powertools/powertools-lambda-java" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Homepage
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../FAQs/" class="md-nav__link">
        FAQs
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
      
      
        
      
      <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" tabindex="0" aria-expanded="false">
          Core utilities
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Core utilities" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Core utilities
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/logging/" class="md-nav__link">
        Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/tracing/" class="md-nav__link">
        Tracing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../core/metrics/" class="md-nav__link">
        Metrics
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " data-md-toggle="__nav_5" type="checkbox" id="__nav_5" checked>
      
      
      
        <label class="md-nav__link" for="__nav_5" tabindex="0" aria-expanded="true">
          Utilities
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utilities" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Utilities
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Idempotency
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Idempotency
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#terminology" class="md-nav__link">
    Terminology
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    Key features
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    Getting started
  </a>
  
    <nav class="md-nav" aria-label="Getting started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#required-resources" class="md-nav__link">
    Required resources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idempotent-annotation" class="md-nav__link">
    Idempotent annotation
  </a>
  
    <nav class="md-nav" aria-label="Idempotent annotation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#idempotent-annotation-on-another-method" class="md-nav__link">
    Idempotent annotation on another method
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#choosing-a-payload-subset-for-idempotency" class="md-nav__link">
    Choosing a payload subset for idempotency
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idempotency-request-flow" class="md-nav__link">
    Idempotency request flow
  </a>
  
    <nav class="md-nav" aria-label="Idempotency request flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lambda-timeouts" class="md-nav__link">
    Lambda timeouts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lambda-timeout-sequence-diagram" class="md-nav__link">
    Lambda timeout sequence diagram
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-exceptions" class="md-nav__link">
    Handling exceptions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistence-stores" class="md-nav__link">
    Persistence stores
  </a>
  
    <nav class="md-nav" aria-label="Persistence stores">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamodbpersistencestore" class="md-nav__link">
    DynamoDBPersistenceStore
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced" class="md-nav__link">
    Advanced
  </a>
  
    <nav class="md-nav" aria-label="Advanced">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customizing-the-default-behavior" class="md-nav__link">
    Customizing the default behavior
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-concurrent-executions-with-the-same-payload" class="md-nav__link">
    Handling concurrent executions with the same payload
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-in-memory-cache" class="md-nav__link">
    Using in-memory cache
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expiring-idempotency-records" class="md-nav__link">
    Expiring idempotency records
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#payload-validation" class="md-nav__link">
    Payload validation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-idempotency-key-required" class="md-nav__link">
    Making idempotency key required
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customizing-dynamodb-configuration" class="md-nav__link">
    Customizing DynamoDB configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-dynamodb-table-with-a-composite-primary-key" class="md-nav__link">
    Using a DynamoDB table with a composite primary key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bring-your-own-persistent-store" class="md-nav__link">
    Bring your own persistent store
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compatibility-with-other-utilities" class="md-nav__link">
    Compatibility with other utilities
  </a>
  
    <nav class="md-nav" aria-label="Compatibility with other utilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validation-utility" class="md-nav__link">
    Validation utility
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-your-code" class="md-nav__link">
    Testing your code
  </a>
  
    <nav class="md-nav" aria-label="Testing your code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disabling-the-idempotency-utility" class="md-nav__link">
    Disabling the idempotency utility
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-with-dynamodb-local" class="md-nav__link">
    Testing with DynamoDB Local
  </a>
  
    <nav class="md-nav" aria-label="Testing with DynamoDB Local">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-tests" class="md-nav__link">
    Unit tests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sam-local" class="md-nav__link">
    SAM Local
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extra-resources" class="md-nav__link">
    Extra resources
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../parameters/" class="md-nav__link">
        Parameters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../sqs_large_message_handling/" class="md-nav__link">
        SQS Large Message Handling
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../batch/" class="md-nav__link">
        SQS Batch Processing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../validation/" class="md-nav__link">
        Validation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../custom_resources/" class="md-nav__link">
        Custom Resources
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../serialization/" class="md-nav__link">
        Serialization Utilities
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#terminology" class="md-nav__link">
    Terminology
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    Key features
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    Getting started
  </a>
  
    <nav class="md-nav" aria-label="Getting started">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#required-resources" class="md-nav__link">
    Required resources
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idempotent-annotation" class="md-nav__link">
    Idempotent annotation
  </a>
  
    <nav class="md-nav" aria-label="Idempotent annotation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#idempotent-annotation-on-another-method" class="md-nav__link">
    Idempotent annotation on another method
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#choosing-a-payload-subset-for-idempotency" class="md-nav__link">
    Choosing a payload subset for idempotency
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idempotency-request-flow" class="md-nav__link">
    Idempotency request flow
  </a>
  
    <nav class="md-nav" aria-label="Idempotency request flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lambda-timeouts" class="md-nav__link">
    Lambda timeouts
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lambda-timeout-sequence-diagram" class="md-nav__link">
    Lambda timeout sequence diagram
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-exceptions" class="md-nav__link">
    Handling exceptions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistence-stores" class="md-nav__link">
    Persistence stores
  </a>
  
    <nav class="md-nav" aria-label="Persistence stores">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dynamodbpersistencestore" class="md-nav__link">
    DynamoDBPersistenceStore
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced" class="md-nav__link">
    Advanced
  </a>
  
    <nav class="md-nav" aria-label="Advanced">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#customizing-the-default-behavior" class="md-nav__link">
    Customizing the default behavior
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-concurrent-executions-with-the-same-payload" class="md-nav__link">
    Handling concurrent executions with the same payload
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-in-memory-cache" class="md-nav__link">
    Using in-memory cache
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#expiring-idempotency-records" class="md-nav__link">
    Expiring idempotency records
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#payload-validation" class="md-nav__link">
    Payload validation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-idempotency-key-required" class="md-nav__link">
    Making idempotency key required
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#customizing-dynamodb-configuration" class="md-nav__link">
    Customizing DynamoDB configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-dynamodb-table-with-a-composite-primary-key" class="md-nav__link">
    Using a DynamoDB table with a composite primary key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bring-your-own-persistent-store" class="md-nav__link">
    Bring your own persistent store
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#compatibility-with-other-utilities" class="md-nav__link">
    Compatibility with other utilities
  </a>
  
    <nav class="md-nav" aria-label="Compatibility with other utilities">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validation-utility" class="md-nav__link">
    Validation utility
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-your-code" class="md-nav__link">
    Testing your code
  </a>
  
    <nav class="md-nav" aria-label="Testing your code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#disabling-the-idempotency-utility" class="md-nav__link">
    Disabling the idempotency utility
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-with-dynamodb-local" class="md-nav__link">
    Testing with DynamoDB Local
  </a>
  
    <nav class="md-nav" aria-label="Testing with DynamoDB Local">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#unit-tests" class="md-nav__link">
    Unit tests
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sam-local" class="md-nav__link">
    SAM Local
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extra-resources" class="md-nav__link">
    Extra resources
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  



  <h1>Idempotency</h1>

<p>The idempotency utility provides a simple solution to convert your Lambda functions into idempotent operations which
are safe to retry.</p>
<h2 id="terminology">Terminology<a class="headerlink" href="#terminology" title="Permanent link">&para;</a></h2>
<p>The property of idempotency means that an operation does not cause additional side effects if it is called more than
once with the same input parameters.</p>
<p><strong>Idempotent operations will return the same result when they are called multiple
times with the same parameters</strong>. This makes idempotent operations safe to retry. <a href="https://aws.amazon.com/builders-library/making-retries-safe-with-idempotent-APIs/">Read more</a> about idempotency.</p>
<p><strong>Idempotency key</strong> is a hash representation of either the entire event or a specific configured subset of the event, and invocation results are <strong>JSON serialized</strong> and stored in your persistence storage layer.</p>
<h2 id="key-features">Key features<a class="headerlink" href="#key-features" title="Permanent link">&para;</a></h2>
<ul>
<li>Prevent Lambda handler function from executing more than once on the same event payload during a time window</li>
<li>Ensure Lambda handler returns the same result when called with the same payload</li>
<li>Select a subset of the event as the idempotency key using JMESPath expressions</li>
<li>Set a time window in which records with the same payload should be considered duplicates</li>
</ul>
<h2 id="getting-started">Getting started<a class="headerlink" href="#getting-started" title="Permanent link">&para;</a></h2>
<h3 id="installation">Installation<a class="headerlink" href="#installation" title="Permanent link">&para;</a></h3>
<p>Depending on your version of Java (either Java 1.8 or 11+), the configuration slightly changes.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><input id="__tabbed_1_3" name="__tabbed_1" type="radio" /><input id="__tabbed_1_4" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Maven Java 11+</label><label for="__tabbed_1_2">Maven Java 1.8</label><label for="__tabbed_1_3">Gradle Java 11+</label><label for="__tabbed_1_4">Gradle Java 1.8</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nt">&lt;dependencies&gt;</span>
<span class="w">    </span>...
<span class="hll"><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>software.amazon.lambda<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>powertools-idempotency<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;version&gt;</span>1.16.0<span class="nt">&lt;/version&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span class="w">    </span>...
<span class="nt">&lt;/dependencies&gt;</span>
...
<span class="cm">&lt;!-- configure the aspectj-maven-plugin to compile-time weave (CTW) the aws-lambda-powertools-java aspects into your project --&gt;</span>
<span class="nt">&lt;build&gt;</span>
<span class="w">    </span><span class="nt">&lt;plugins&gt;</span>
<span class="w">        </span>...
<span class="w">        </span><span class="nt">&lt;plugin&gt;</span>
<span class="hll"><span class="w">             </span><span class="nt">&lt;groupId&gt;</span>dev.aspectj<span class="nt">&lt;/groupId&gt;</span>
</span><span class="w">             </span><span class="nt">&lt;artifactId&gt;</span>aspectj-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
<span class="hll"><span class="w">             </span><span class="nt">&lt;version&gt;</span>1.13.1<span class="nt">&lt;/version&gt;</span>
</span><span class="w">             </span><span class="nt">&lt;configuration&gt;</span>
<span class="w">                 </span><span class="nt">&lt;source&gt;</span>11<span class="nt">&lt;/source&gt;</span><span class="w"> </span><span class="cm">&lt;!-- or higher --&gt;</span>
<span class="w">                 </span><span class="nt">&lt;target&gt;</span>11<span class="nt">&lt;/target&gt;</span><span class="w"> </span><span class="cm">&lt;!-- or higher --&gt;</span>
<span class="w">                 </span><span class="nt">&lt;complianceLevel&gt;</span>11<span class="nt">&lt;/complianceLevel&gt;</span><span class="w"> </span><span class="cm">&lt;!-- or higher --&gt;</span>
<span class="w">                 </span><span class="nt">&lt;aspectLibraries&gt;</span>
<span class="hll"><span class="w">                     </span><span class="nt">&lt;aspectLibrary&gt;</span>
</span><span class="hll"><span class="w">                         </span><span class="nt">&lt;groupId&gt;</span>software.amazon.lambda<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll"><span class="w">                         </span><span class="nt">&lt;artifactId&gt;</span>powertools-idempotency<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll"><span class="w">                     </span><span class="nt">&lt;/aspectLibrary&gt;</span>
</span><span class="w">                 </span><span class="nt">&lt;/aspectLibraries&gt;</span>
<span class="w">             </span><span class="nt">&lt;/configuration&gt;</span>
<span class="w">             </span><span class="nt">&lt;executions&gt;</span>
<span class="w">                 </span><span class="nt">&lt;execution&gt;</span>
<span class="w">                     </span><span class="nt">&lt;goals&gt;</span>
<span class="w">                         </span><span class="nt">&lt;goal&gt;</span>compile<span class="nt">&lt;/goal&gt;</span>
<span class="w">                     </span><span class="nt">&lt;/goals&gt;</span>
<span class="w">                 </span><span class="nt">&lt;/execution&gt;</span>
<span class="w">             </span><span class="nt">&lt;/executions&gt;</span>
<span class="w">        </span><span class="nt">&lt;/plugin&gt;</span>
<span class="w">        </span>...
<span class="w">    </span><span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nt">&lt;dependencies&gt;</span>
<span class="w">    </span>...
<span class="hll"><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>software.amazon.lambda<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>powertools-idempotency<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;version&gt;</span>1.16.0<span class="nt">&lt;/version&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</span><span class="w">    </span>...
<span class="nt">&lt;/dependencies&gt;</span>
...
<span class="cm">&lt;!-- configure the aspectj-maven-plugin to compile-time weave (CTW) the aws-lambda-powertools-java aspects into your project --&gt;</span>
<span class="nt">&lt;build&gt;</span>
<span class="w">    </span><span class="nt">&lt;plugins&gt;</span>
<span class="w">        </span>...
<span class="w">        </span><span class="nt">&lt;plugin&gt;</span>
<span class="hll"><span class="w">             </span><span class="nt">&lt;groupId&gt;</span>org.codehaus.mojo<span class="nt">&lt;/groupId&gt;</span>
</span><span class="w">             </span><span class="nt">&lt;artifactId&gt;</span>aspectj-maven-plugin<span class="nt">&lt;/artifactId&gt;</span>
<span class="hll"><span class="w">             </span><span class="nt">&lt;version&gt;</span>1.14.0<span class="nt">&lt;/version&gt;</span>
</span><span class="w">             </span><span class="nt">&lt;configuration&gt;</span>
<span class="w">                 </span><span class="nt">&lt;source&gt;</span>1.8<span class="nt">&lt;/source&gt;</span>
<span class="w">                 </span><span class="nt">&lt;target&gt;</span>1.8<span class="nt">&lt;/target&gt;</span>
<span class="w">                 </span><span class="nt">&lt;complianceLevel&gt;</span>1.8<span class="nt">&lt;/complianceLevel&gt;</span>
<span class="w">                 </span><span class="nt">&lt;aspectLibraries&gt;</span>
<span class="hll"><span class="w">                     </span><span class="nt">&lt;aspectLibrary&gt;</span>
</span><span class="hll"><span class="w">                         </span><span class="nt">&lt;groupId&gt;</span>software.amazon.lambda<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll"><span class="w">                         </span><span class="nt">&lt;artifactId&gt;</span>powertools-idempotency<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll"><span class="w">                     </span><span class="nt">&lt;/aspectLibrary&gt;</span>
</span><span class="w">                 </span><span class="nt">&lt;/aspectLibraries&gt;</span>
<span class="w">             </span><span class="nt">&lt;/configuration&gt;</span>
<span class="w">             </span><span class="nt">&lt;executions&gt;</span>
<span class="w">                 </span><span class="nt">&lt;execution&gt;</span>
<span class="w">                     </span><span class="nt">&lt;goals&gt;</span>
<span class="w">                         </span><span class="nt">&lt;goal&gt;</span>compile<span class="nt">&lt;/goal&gt;</span>
<span class="w">                     </span><span class="nt">&lt;/goals&gt;</span>
<span class="w">                 </span><span class="nt">&lt;/execution&gt;</span>
<span class="w">             </span><span class="nt">&lt;/executions&gt;</span>
<span class="w">        </span><span class="nt">&lt;/plugin&gt;</span>
<span class="w">        </span>...
<span class="w">    </span><span class="nt">&lt;/plugins&gt;</span>
<span class="nt">&lt;/build&gt;</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">    </span><span class="n">plugins</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">id</span><span class="w"> </span><span class="s1">&#39;java&#39;</span>
<span class="hll"><span class="w">        </span><span class="n">id</span><span class="w"> </span><span class="s1">&#39;io.freefair.aspectj.post-compile-weaving&#39;</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s1">&#39;8.1.0&#39;</span>
</span><span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="n">repositories</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">mavenCentral</span><span class="o">()</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="n">dependencies</span><span class="w"> </span><span class="o">{</span>
<span class="hll"><span class="w">        </span><span class="n">aspect</span><span class="w"> </span><span class="s1">&#39;software.amazon.lambda:powertools-idempotency:1.16.0&#39;</span>
</span><span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="n">sourceCompatibility</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="c1">// or higher</span>
<span class="w">    </span><span class="n">targetCompatibility</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="c1">// or higher</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">    </span><span class="n">plugins</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">id</span><span class="w"> </span><span class="s1">&#39;java&#39;</span>
<span class="hll"><span class="w">        </span><span class="n">id</span><span class="w"> </span><span class="s1">&#39;io.freefair.aspectj.post-compile-weaving&#39;</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="s1">&#39;6.6.3&#39;</span>
</span><span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="n">repositories</span><span class="w"> </span><span class="o">{</span>
<span class="w">        </span><span class="n">mavenCentral</span><span class="o">()</span>
<span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="n">dependencies</span><span class="w"> </span><span class="o">{</span>
<span class="hll"><span class="w">        </span><span class="n">aspect</span><span class="w"> </span><span class="s1">&#39;software.amazon.lambda:powertools-idempotency:1.16.0&#39;</span>
</span><span class="w">    </span><span class="o">}</span>

<span class="w">    </span><span class="n">sourceCompatibility</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.8</span>
<span class="w">    </span><span class="n">targetCompatibility</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.8</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h3 id="required-resources">Required resources<a class="headerlink" href="#required-resources" title="Permanent link">&para;</a></h3>
<p>Before getting started, you need to create a persistent storage layer where the idempotency utility can store its state - your Lambda functions will need read and write access to it.</p>
<p>As of now, Amazon DynamoDB is the only supported persistent storage layer, so you'll need to create a table first.</p>
<p><strong>Default table configuration</strong></p>
<p>If you're not <a href="#dynamodbpersistencestore">changing the default configuration for the DynamoDB persistence layer</a>, this is the expected default configuration:</p>
<table>
<thead>
<tr>
<th>Configuration</th>
<th>Value</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td>Partition key</td>
<td><code>id</code></td>
<td></td>
</tr>
<tr>
<td>TTL attribute name</td>
<td><code>expiration</code></td>
<td>This can only be configured after your table is created if you're using AWS Console</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">Tip: You can share a single state table for all functions</p>
<p>You can reuse the same DynamoDB table to store idempotency state. We add your function name in addition to the idempotency key as a hash key.</p>
</div>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">AWS Serverless Application Model (SAM) example</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nt">Resources</span><span class="p">:</span>
<span class="w">  </span><span class="nt">IdempotencyTable</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::DynamoDB::Table</span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="hll"><span class="w">      </span><span class="nt">AttributeDefinitions</span><span class="p">:</span>
</span><span class="hll"><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">AttributeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">id</span>
</span><span class="hll"><span class="w">          </span><span class="nt">AttributeType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">S</span>
</span><span class="hll"><span class="w">      </span><span class="nt">KeySchema</span><span class="p">:</span>
</span><span class="hll"><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">AttributeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">id</span>
</span><span class="hll"><span class="w">          </span><span class="nt">KeyType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HASH</span>
</span><span class="hll"><span class="w">      </span><span class="nt">TimeToLiveSpecification</span><span class="p">:</span>
</span><span class="hll"><span class="w">        </span><span class="nt">AttributeName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">expiration</span>
</span><span class="hll"><span class="w">        </span><span class="nt">Enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span class="w">      </span><span class="nt">BillingMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PAY_PER_REQUEST</span>

<span class="w">  </span><span class="nt">IdempotencyFunction</span><span class="p">:</span>
<span class="w">    </span><span class="nt">Type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AWS::Serverless::Function</span>
<span class="w">    </span><span class="nt">Properties</span><span class="p">:</span>
<span class="w">      </span><span class="nt">CodeUri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Function</span>
<span class="w">      </span><span class="nt">Handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">helloworld.App::handleRequest</span>
<span class="hll"><span class="w">      </span><span class="nt">Policies</span><span class="p">:</span>
</span><span class="hll"><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">DynamoDBCrudPolicy</span><span class="p">:</span>
</span><span class="hll"><span class="w">            </span><span class="nt">TableName</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IdempotencyTable</span>
</span><span class="w">      </span><span class="nt">Environment</span><span class="p">:</span>
<span class="w">        </span><span class="nt">Variables</span><span class="p">:</span>
<span class="hll"><span class="w">          </span><span class="nt">IDEMPOTENCY_TABLE</span><span class="p">:</span><span class="w"> </span><span class="kt">!Ref</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IdempotencyTable</span>
</span></code></pre></div></td></tr></table></div>
<div class="admonition warning">
<p class="admonition-title">Warning: Large responses with DynamoDB persistence layer</p>
<p>When using this utility with DynamoDB, your function's responses must be <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Limits.html#limits-items">smaller than 400KB</a>.
Larger items cannot be written to DynamoDB and will cause exceptions.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info: DynamoDB</p>
<p>Each function invocation will generally make 2 requests to DynamoDB. If the
result returned by your Lambda is less than 1kb, you can expect 2 WCUs per invocation. For retried invocations, you will
see 1WCU and 1RCU. Review the <a href="https://aws.amazon.com/dynamodb/pricing/">DynamoDB pricing documentation</a> to
estimate the cost.</p>
</div>
<h3 id="idempotent-annotation">Idempotent annotation<a class="headerlink" href="#idempotent-annotation" title="Permanent link">&para;</a></h3>
<p>You can quickly start by initializing the <code>DynamoDBPersistenceStore</code> and using it with the <code>@Idempotent</code> annotation on your Lambda handler.</p>
<div class="admonition warning">
<p class="admonition-title">Important</p>
<p>Initialization and configuration of the <code>DynamoDBPersistenceStore</code> must be performed outside the handler, preferably in the constructor.</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">App.java</label><label for="__tabbed_2_2">Example event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">App</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">RequestHandler</span><span class="o">&lt;</span><span class="n">Subscription</span><span class="p">,</span><span class="w"> </span><span class="n">SubscriptionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// we need to initialize idempotency store before the handleRequest method is called</span>
<span class="hll"><span class="w">    </span><span class="n">Idempotency</span><span class="p">.</span><span class="na">config</span><span class="p">().</span><span class="na">withPersistenceStore</span><span class="p">(</span>
</span><span class="hll"><span class="w">      </span><span class="n">DynamoDBPersistenceStore</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
</span><span class="hll"><span class="w">        </span><span class="p">.</span><span class="na">withTableName</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;TABLE_NAME&quot;</span><span class="p">))</span>
</span><span class="hll"><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
</span><span class="hll"><span class="w">      </span><span class="p">).</span><span class="na">configure</span><span class="p">();</span>
</span><span class="w">  </span><span class="p">}</span>

<span class="hll"><span class="w">  </span><span class="nd">@Idempotent</span>
</span><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SubscriptionResult</span><span class="w"> </span><span class="nf">handleRequest</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Subscription</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">SubscriptionPayment</span><span class="w"> </span><span class="n">payment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createSubscriptionPayment</span><span class="p">(</span>
<span class="w">      </span><span class="n">event</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span>
<span class="w">      </span><span class="n">event</span><span class="p">.</span><span class="na">getProductId</span><span class="p">()</span>
<span class="w">    </span><span class="p">);</span>

<span class="hll"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SubscriptionResult</span><span class="p">(</span><span class="n">payment</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;success&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">);</span>
</span><span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;xyz&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;product_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;123456789&quot;</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h4 id="idempotent-annotation-on-another-method">Idempotent annotation on another method<a class="headerlink" href="#idempotent-annotation-on-another-method" title="Permanent link">&para;</a></h4>
<p>You can use the <code>@Idempotent</code> annotation for any synchronous Java function, not only the <code>handleRequest</code> one.</p>
<p>When using <code>@Idempotent</code> annotation on another method, you must tell which parameter in the method signature has the data we should use:</p>
<ul>
<li>If the method only has one parameter, it will be used by default. </li>
<li>If there are 2 or more parameters, you must set the <code>@IdempotencyKey</code> on the parameter to use.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">The parameter must be serializable in JSON. We use Jackson internally to (de)serialize objects</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">AppSqsEvent.java</label><label for="__tabbed_3_2">Batch event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>This example also demonstrates how you can integrate with <a href="../batch/">Batch utility</a>, so you can process each record in an idempotent manner.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AppSqsEvent</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">RequestHandler</span><span class="o">&lt;</span><span class="n">SQSEvent</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">AppSqsEvent</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Idempotency</span><span class="p">.</span><span class="na">config</span><span class="p">()</span>
<span class="w">      </span><span class="p">.</span><span class="na">withPersistenceStore</span><span class="p">(</span>
<span class="w">          </span><span class="n">DynamoDBPersistenceStore</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">withTableName</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;TABLE_NAME&quot;</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
<span class="w">      </span><span class="p">).</span><span class="na">withConfig</span><span class="p">(</span>
<span class="w">           </span><span class="n">IdempotencyConfig</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">             </span><span class="p">.</span><span class="na">withEventKeyJMESPath</span><span class="p">(</span><span class="s">&quot;messageId&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// see Choosing a payload subset section</span>
<span class="w">             </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
<span class="w">      </span><span class="p">).</span><span class="na">configure</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="nd">@Override</span>
<span class="w">  </span><span class="nd">@SqsBatch</span><span class="p">(</span><span class="n">SampleMessageHandler</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">handleRequest</span><span class="p">(</span><span class="n">SQSEvent</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">    </span><span class="n">dummy</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;world&quot;</span><span class="p">);</span>
</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;{\&quot;statusCode\&quot;: 200}&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="hll"><span class="w">  </span><span class="nd">@Idempotent</span>
</span><span class="hll"><span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">dummy</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">argOne</span><span class="p">,</span><span class="w"> </span><span class="nd">@IdempotencyKey</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">argTwo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;something&quot;</span><span class="p">;</span>
</span><span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SampleMessageHandler</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">SqsMessageHandler</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Override</span>
<span class="hll"><span class="w">    </span><span class="nd">@Idempotent</span>
</span><span class="hll"><span class="w">    </span><span class="c1">// no need to use @IdempotencyKey as there is only one parameter</span>
</span><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">SQSMessage</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">String</span><span class="w"> </span><span class="n">returnVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">doSomething</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getBody</span><span class="p">());</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">returnVal</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Records&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="hll"><span class="w">            </span><span class="nt">&quot;messageId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;059f36b4-87a3-44ab-83d2-661975830a7d&quot;</span><span class="p">,</span>
</span><span class="w">            </span><span class="nt">&quot;receiptHandle&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AQEBwJnKyrHigUMZj6rYigCgxlaS3SLy0a...&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;body&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Test message.&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;attributes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;ApproximateReceiveCount&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;SentTimestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1545082649183&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;SenderId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AIDAIENQZJOLO23YVJ4VO&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;ApproximateFirstReceiveTimestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1545082649185&quot;</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nt">&quot;messageAttributes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;testAttr&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;stringValue&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;100&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;binaryValue&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;base64Str&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;dataType&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Number&quot;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nt">&quot;md5OfBody&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;e4e68fb7bd0e697a0ae8f1bb342846b3&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;eventSource&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;aws:sqs&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;eventSourceARN&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;arn:aws:sqs:us-east-2:123456789012:my-queue&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;awsRegion&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;us-east-2&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h3 id="choosing-a-payload-subset-for-idempotency">Choosing a payload subset for idempotency<a class="headerlink" href="#choosing-a-payload-subset-for-idempotency" title="Permanent link">&para;</a></h3>
<div class="admonition tip">
<p class="admonition-title">Tip: Dealing with always changing payloads</p>
<p>When dealing with an elaborate payload (API Gateway request for example), where parts of the payload always change, you should configure the <strong><code>EventKeyJMESPath</code></strong>.</p>
</div>
<p>Use <a href="#customizing-the-default-behavior"><code>IdempotencyConfig</code></a> to instruct the Idempotent annotation to only use a portion of your payload to verify whether a request is idempotent, and therefore it should not be retried.</p>
<blockquote>
<p><strong>Payment scenario</strong></p>
</blockquote>
<p>In this example, we have a Lambda handler that creates a payment for a user subscribing to a product. We want to ensure that we don't accidentally charge our customer by subscribing them more than once.</p>
<p>Imagine the function executes successfully, but the client never receives the response due to a connection issue. It is safe to retry in this instance, as the idempotent decorator will return a previously saved response.</p>
<div class="admonition warning">
<p class="admonition-title">Warning: Idempotency for JSON payloads</p>
<p>The payload extracted by the <code>EventKeyJMESPath</code> is treated as a string by default, so will be sensitive to differences in whitespace even when the JSON payload itself is identical.</p>
<p>To alter this behaviour, you can use the <a href="../serialization/#jmespath-functions">JMESPath built-in function</a> <code>powertools_json()</code> to treat the payload as a JSON object rather than a string.</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">PaymentFunction.java</label><label for="__tabbed_4_2">Example event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PaymentFunction</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">RequestHandler</span><span class="o">&lt;</span><span class="n">APIGatewayProxyRequestEvent</span><span class="p">,</span><span class="w"> </span><span class="n">APIGatewayProxyResponseEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">PaymentFunction</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Idempotency</span><span class="p">.</span><span class="na">config</span><span class="p">()</span>
<span class="hll"><span class="w">    </span><span class="p">.</span><span class="na">withConfig</span><span class="p">(</span>
</span><span class="hll"><span class="w">        </span><span class="n">IdempotencyConfig</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
</span><span class="hll"><span class="w">          </span><span class="p">.</span><span class="na">withEventKeyJMESPath</span><span class="p">(</span><span class="s">&quot;powertools_json(body)&quot;</span><span class="p">)</span>
</span><span class="w">          </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="na">withPersistenceStore</span><span class="p">(</span>
<span class="w">        </span><span class="n">DynamoDBPersistenceStore</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">          </span><span class="p">.</span><span class="na">withTableName</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;TABLE_NAME&quot;</span><span class="p">))</span>
<span class="w">          </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="na">configure</span><span class="p">();</span>
<span class="p">}</span>

<span class="hll"><span class="nd">@Idempotent</span>
</span><span class="kd">public</span><span class="w"> </span><span class="n">APIGatewayProxyResponseEvent</span><span class="w"> </span><span class="nf">handleRequest</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">APIGatewayProxyRequestEvent</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">APIGatewayProxyResponseEvent</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">APIGatewayProxyResponseEvent</span><span class="p">();</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Subscription</span><span class="w"> </span><span class="n">subscription</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">JsonConfig</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getObjectMapper</span><span class="p">().</span><span class="na">readValue</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getBody</span><span class="p">(),</span><span class="w"> </span><span class="n">Subscription</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>

<span class="w">    </span><span class="n">SubscriptionPayment</span><span class="w"> </span><span class="n">payment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createSubscriptionPayment</span><span class="p">(</span>
<span class="w">         </span><span class="n">subscription</span><span class="p">.</span><span class="na">getUsername</span><span class="p">(),</span>
<span class="w">         </span><span class="n">subscription</span><span class="p">.</span><span class="na">getProductId</span><span class="p">()</span>
<span class="w">    </span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">response</span>
<span class="hll"><span class="w">             </span><span class="p">.</span><span class="na">withStatusCode</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
</span><span class="hll"><span class="w">             </span><span class="p">.</span><span class="na">withBody</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">format</span><span class="p">(</span><span class="s">&quot;{\&quot;paymentId\&quot;:\&quot;%s\&quot;}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">payment</span><span class="p">.</span><span class="na">getId</span><span class="p">()));</span>
</span><span class="hll">
</span><span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">JsonProcessingException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="na">withStatusCode</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
<span class="hll"><span class="w">  </span><span class="nt">&quot;body&quot;</span><span class="p">:</span><span class="s2">&quot;{\&quot;username\&quot;:\&quot;xyz\&quot;,\&quot;productId\&quot;:\&quot;123456789\&quot;}&quot;</span><span class="p">,</span>
</span><span class="w">  </span><span class="nt">&quot;routeKey&quot;</span><span class="p">:</span><span class="s2">&quot;ANY /createpayment&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;rawPath&quot;</span><span class="p">:</span><span class="s2">&quot;/createpayment&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;rawQueryString&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;headers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;Header1&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value1&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;Header2&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;value2&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;requestContext&quot;</span><span class="p">:{</span>
<span class="w">    </span><span class="nt">&quot;accountId&quot;</span><span class="p">:</span><span class="s2">&quot;123456789012&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;apiId&quot;</span><span class="p">:</span><span class="s2">&quot;api-id&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;domainName&quot;</span><span class="p">:</span><span class="s2">&quot;id.execute-api.us-east-1.amazonaws.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;domainPrefix&quot;</span><span class="p">:</span><span class="s2">&quot;id&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;http&quot;</span><span class="p">:{</span>
<span class="w">      </span><span class="nt">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;path&quot;</span><span class="p">:</span><span class="s2">&quot;/createpayment&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;protocol&quot;</span><span class="p">:</span><span class="s2">&quot;HTTP/1.1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;sourceIp&quot;</span><span class="p">:</span><span class="s2">&quot;ip&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;userAgent&quot;</span><span class="p">:</span><span class="s2">&quot;agent&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;requestId&quot;</span><span class="p">:</span><span class="s2">&quot;id&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;routeKey&quot;</span><span class="p">:</span><span class="s2">&quot;ANY /createpayment&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;stage&quot;</span><span class="p">:</span><span class="s2">&quot;$default&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="s2">&quot;10/Feb/2021:13:40:43 +0000&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;timeEpoch&quot;</span><span class="p">:</span><span class="mi">1612964443723</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;isBase64Encoded&quot;</span><span class="p">:</span><span class="kc">false</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h3 id="idempotency-request-flow">Idempotency request flow<a class="headerlink" href="#idempotency-request-flow" title="Permanent link">&para;</a></h3>
<p>This sequence diagram shows an example flow of what happens in the payment scenario:</p>
<p><center>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant Lambda
    participant Persistence Layer
    alt initial request
        Client-&gt;&gt;Lambda: Invoke (event)
        Lambda-&gt;&gt;Persistence Layer: Get or set (id=event.search(payload))
        activate Persistence Layer
        Note right of Persistence Layer: Locked to prevent concurrent&lt;br/&gt;invocations with &lt;br/&gt; the same payload.
        Lambda--&gt;&gt;Lambda: Call handler (event)
        Lambda-&gt;&gt;Persistence Layer: Update record with result
        deactivate Persistence Layer
        Persistence Layer--&gt;&gt;Persistence Layer: Update record with result
        Lambda--&gt;&gt;Client: Response sent to client
    else retried request
        Client-&gt;&gt;Lambda: Invoke (event)
        Lambda-&gt;&gt;Persistence Layer: Get or set (id=event.search(payload))
        Persistence Layer--&gt;&gt;Lambda: Already exists in persistence layer. Return result
        Lambda--&gt;&gt;Client: Response sent to client
    end</code></pre>
<i>Idempotent sequence</i>
</center></p>
<p>The client was successful in receiving the result after the retry. Since the Lambda handler was only executed once, our customer hasn't been charged twice.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Bear in mind that the entire Lambda handler is treated as a single idempotent operation. If your Lambda handler can cause multiple side effects, consider splitting it into separate functions.</p>
</div>
<h4 id="lambda-timeouts">Lambda timeouts<a class="headerlink" href="#lambda-timeouts" title="Permanent link">&para;</a></h4>
<p>This is automatically done when you annotate your Lambda handler with <a href="#idempotent-annotation">@Idempotent annotation</a>.</p>
<p>To prevent against extended failed retries when a <a href="https://aws.amazon.com/premiumsupport/knowledge-center/lambda-verify-invocation-timeouts/">Lambda function times out</a>, Powertools for AWS Lambda (Java) calculates and includes the remaining invocation available time as part of the idempotency record.</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<p>If a second invocation happens <strong>after</strong> this timestamp, and the record is marked as <code>INPROGRESS</code>, we will execute the invocation again as if it was in the <code>EXPIRED</code> state.
This means that if an invocation expired during execution, it will be quickly executed again on the next retry.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If you are using the <a href="#idempotent-annotation-on-another-method">@Idempotent annotation on another method</a> to guard isolated parts of your code, you must use <code>registerLambdaContext</code> method available in the <code>Idempotency</code> object to benefit from this protection.</p>
<p>Here is an example on how you register the Lambda context in your handler:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Registering the Lambda context</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PaymentHandler</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">RequestHandler</span><span class="o">&lt;</span><span class="n">SQSEvent</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">PaymentHandler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Idempotency</span><span class="p">.</span><span class="na">config</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="na">withPersistenceStore</span><span class="p">(</span>
<span class="w">                        </span><span class="n">DynamoDBPersistenceStore</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                                </span><span class="p">.</span><span class="na">withTableName</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;IDEMPOTENCY_TABLE&quot;</span><span class="p">))</span>
<span class="w">                                </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">configure</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="hll"><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">handleRequest</span><span class="p">(</span><span class="n">SQSEvent</span><span class="w"> </span><span class="n">sqsEvent</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="n">Idempotency</span><span class="p">.</span><span class="na">registerLambdaContext</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
</span><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sqsEvent</span><span class="p">.</span><span class="na">getRecords</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">process</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getMessageId</span><span class="p">(),</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">getBody</span><span class="p">())).</span><span class="na">collect</span><span class="p">(</span><span class="n">Collectors</span><span class="p">.</span><span class="na">toList</span><span class="p">());</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><span class="hll">
</span><span class="hll"><span class="w">    </span><span class="nd">@Idempotent</span>
</span><span class="hll"><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">messageId</span><span class="p">,</span><span class="w"> </span><span class="nd">@IdempotencyKey</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">messageBody</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="w">        </span><span class="n">logger</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Processing messageId: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">messageId</span><span class="p">);</span>
<span class="w">        </span><span class="n">PaymentRequest</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractDataFrom</span><span class="p">(</span><span class="n">messageBody</span><span class="p">).</span><span class="na">as</span><span class="p">(</span><span class="n">PaymentRequest</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">paymentService</span><span class="p">.</span><span class="na">process</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<h4 id="lambda-timeout-sequence-diagram">Lambda timeout sequence diagram<a class="headerlink" href="#lambda-timeout-sequence-diagram" title="Permanent link">&para;</a></h4>
<p>This sequence diagram shows an example flow of what happens if a Lambda function times out:</p>
<p><center>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant Lambda
    participant Persistence Layer
    alt initial request
        Client-&gt;&gt;Lambda: Invoke (event)
        Lambda-&gt;&gt;Persistence Layer: Get or set (id=event.search(payload))
        activate Persistence Layer
        Note right of Persistence Layer: Locked to prevent concurrent&lt;br/&gt;invocations with &lt;br/&gt; the same payload.
        Note over Lambda: Time out
        Lambda--xLambda: Call handler (event)
        Lambda--&gt;&gt;Client: Return error response
        deactivate Persistence Layer
    else concurrent request before timeout
        Client-&gt;&gt;Lambda: Invoke (event)
        Lambda-&gt;&gt;Persistence Layer: Get or set (id=event.search(payload))
        Persistence Layer--&gt;&gt;Lambda: Request already INPROGRESS
        Lambda--xClient: Return IdempotencyAlreadyInProgressError
    else retry after Lambda timeout
        Client-&gt;&gt;Lambda: Invoke (event)
        Lambda-&gt;&gt;Persistence Layer: Get or set (id=event.search(payload))
        activate Persistence Layer
        Note right of Persistence Layer: Locked to prevent concurrent&lt;br/&gt;invocations with &lt;br/&gt; the same payload.
        Lambda--&gt;&gt;Lambda: Call handler (event)
        Lambda-&gt;&gt;Persistence Layer: Update record with result
        deactivate Persistence Layer
        Persistence Layer--&gt;&gt;Persistence Layer: Update record with result
        Lambda--&gt;&gt;Client: Response sent to client
    end</code></pre>
<i>Idempotent sequence for Lambda timeouts</i>
</center></p>
<h3 id="handling-exceptions">Handling exceptions<a class="headerlink" href="#handling-exceptions" title="Permanent link">&para;</a></h3>
<p>If you are using the <code>@Idempotent</code> annotation on your Lambda handler or any other method, any unhandled exceptions that are thrown during the code execution will cause <strong>the record in the persistence layer to be deleted</strong>.
This means that new invocations will execute your code again despite having the same payload. If you don't want the record to be deleted, you need to catch exceptions within the idempotent function and return a successful response.</p>
<p><center>
<pre class="mermaid"><code>sequenceDiagram
    participant Client
    participant Lambda
    participant Persistence Layer
    Client-&gt;&gt;Lambda: Invoke (event)
    Lambda-&gt;&gt;Persistence Layer: Get or set (id=event.search(payload))
    activate Persistence Layer
    Note right of Persistence Layer: Locked during this time. Prevents multiple&lt;br/&gt;Lambda invocations with the same&lt;br/&gt;payload running concurrently.
    Lambda--xLambda: Call handler (event).&lt;br/&gt;Raises exception
    Lambda-&gt;&gt;Persistence Layer: Delete record (id=event.search(payload))
    deactivate Persistence Layer
    Lambda--&gt;&gt;Client: Return error response</code></pre>
<i>Idempotent sequence exception</i>
</center></p>
<p>If an Exception is raised <em>outside</em> the scope of a decorated method and after your method has been called, the persistent record will not be affected. In this case, idempotency will be maintained for your decorated function. Example:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Exception not affecting idempotency record sample</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SubscriptionResult</span><span class="w"> </span><span class="nf">handleRequest</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Subscription</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">    </span><span class="c1">// If an exception is thrown here, no idempotent record will ever get created as the</span>
</span><span class="hll"><span class="w">    </span><span class="c1">// idempotent function does not get called </span>
</span><span class="hll"><span class="w">    </span><span class="n">doSomeStuff</span><span class="p">();</span>
</span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idempotentMethod</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

<span class="hll"><span class="w">    </span><span class="c1">// This exception will not cause the idempotent record to be deleted, since it</span>
</span><span class="hll"><span class="w">    </span><span class="c1">// happens after the decorated function has been successfully called    </span>
</span><span class="hll"><span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">();</span>
</span><span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nd">@Idempotent</span>
<span class="w">  </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">idempotentMethod</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Subscription</span><span class="w"> </span><span class="n">subscription</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// perform some operation with no exception thrown</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>We will throw an <code>IdempotencyPersistenceLayerException</code></strong> if any of the calls to the persistence layer fail unexpectedly.</p>
<p>As this happens outside the scope of your decorated function, you are not able to catch it.</p>
</div>
<h3 id="persistence-stores">Persistence stores<a class="headerlink" href="#persistence-stores" title="Permanent link">&para;</a></h3>
<h4 id="dynamodbpersistencestore">DynamoDBPersistenceStore<a class="headerlink" href="#dynamodbpersistencestore" title="Permanent link">&para;</a></h4>
<p>This persistence store is built-in, and you can either use an existing DynamoDB table or create a new one dedicated for idempotency state (recommended).</p>
<p>Use the builder to customize the table structure:
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Customizing DynamoDBPersistenceStore to suit your table structure</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">DynamoDBPersistenceStore</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                        </span><span class="p">.</span><span class="na">withTableName</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;TABLE_NAME&quot;</span><span class="p">))</span>
<span class="hll"><span class="w">                        </span><span class="p">.</span><span class="na">withKeyAttr</span><span class="p">(</span><span class="s">&quot;idempotency_key&quot;</span><span class="p">)</span>
</span><span class="hll"><span class="w">                        </span><span class="p">.</span><span class="na">withExpiryAttr</span><span class="p">(</span><span class="s">&quot;expires_at&quot;</span><span class="p">)</span>
</span><span class="hll"><span class="w">                        </span><span class="p">.</span><span class="na">withStatusAttr</span><span class="p">(</span><span class="s">&quot;current_status&quot;</span><span class="p">)</span>
</span><span class="hll"><span class="w">                        </span><span class="p">.</span><span class="na">withDataAttr</span><span class="p">(</span><span class="s">&quot;result_data&quot;</span><span class="p">)</span>
</span><span class="hll"><span class="w">                        </span><span class="p">.</span><span class="na">withValidationAttr</span><span class="p">(</span><span class="s">&quot;validation_key&quot;</span><span class="p">)</span>
</span><span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></p>
<p>When using DynamoDB as a persistence layer, you can alter the attribute names by passing these parameters when initializing the persistence layer:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>TableName</strong></td>
<td>Y</td>
<td></td>
<td>Table name to store state</td>
</tr>
<tr>
<td><strong>KeyAttr</strong></td>
<td></td>
<td><code>id</code></td>
<td>Partition key of the table. Hashed representation of the payload (unless <strong>SortKeyAttr</strong> is specified)</td>
</tr>
<tr>
<td><strong>ExpiryAttr</strong></td>
<td></td>
<td><code>expiration</code></td>
<td>Unix timestamp of when record expires</td>
</tr>
<tr>
<td><strong>StatusAttr</strong></td>
<td></td>
<td><code>status</code></td>
<td>Stores status of the Lambda execution during and after invocation</td>
</tr>
<tr>
<td><strong>DataAttr</strong></td>
<td></td>
<td><code>data</code></td>
<td>Stores results of successfully idempotent methods</td>
</tr>
<tr>
<td><strong>ValidationAttr</strong></td>
<td></td>
<td><code>validation</code></td>
<td>Hashed representation of the parts of the event used for validation</td>
</tr>
<tr>
<td><strong>SortKeyAttr</strong></td>
<td></td>
<td></td>
<td>Sort key of the table (if table is configured with a sort key).</td>
</tr>
<tr>
<td><strong>StaticPkValue</strong></td>
<td></td>
<td><code>idempotency#{LAMBDA_FUNCTION_NAME}</code></td>
<td>Static value to use as the partition key. Only used when <strong>SortKeyAttr</strong> is set.</td>
</tr>
</tbody>
</table>
<h2 id="advanced">Advanced<a class="headerlink" href="#advanced" title="Permanent link">&para;</a></h2>
<h3 id="customizing-the-default-behavior">Customizing the default behavior<a class="headerlink" href="#customizing-the-default-behavior" title="Permanent link">&para;</a></h3>
<p>Idempotency behavior can be further configured with <strong><code>IdempotencyConfig</code></strong> using a builder:</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Customizing IdempotencyConfig</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">IdempotencyConfig</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="hll"><span class="w">                </span><span class="p">.</span><span class="na">withEventKeyJMESPath</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span>
</span><span class="hll"><span class="w">                </span><span class="p">.</span><span class="na">withPayloadValidationJMESPath</span><span class="p">(</span><span class="s">&quot;paymentId&quot;</span><span class="p">)</span>
</span><span class="hll"><span class="w">                </span><span class="p">.</span><span class="na">withThrowOnNoIdempotencyKey</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span><span class="hll"><span class="w">                </span><span class="p">.</span><span class="na">withExpiration</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">ChronoUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">))</span>
</span><span class="hll"><span class="w">                </span><span class="p">.</span><span class="na">withUseLocalCache</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span><span class="hll"><span class="w">                </span><span class="p">.</span><span class="na">withLocalCacheMaxItems</span><span class="p">(</span><span class="mi">432</span><span class="p">)</span>
</span><span class="hll"><span class="w">                </span><span class="p">.</span><span class="na">withHashFunction</span><span class="p">(</span><span class="s">&quot;SHA-256&quot;</span><span class="p">)</span>
</span><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
<p>These are the available options for further configuration:</p>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>EventKeyJMESPath</strong></td>
<td><code>""</code></td>
<td>JMESPath expression to extract the idempotency key from the event record. See available <a href="serialization">built-in functions</a></td>
</tr>
<tr>
<td><strong>PayloadValidationJMESPath</strong></td>
<td><code>""</code></td>
<td>JMESPath expression to validate whether certain parameters have changed in the event</td>
</tr>
<tr>
<td><strong>ThrowOnNoIdempotencyKey</strong></td>
<td><code>False</code></td>
<td>Throw exception if no idempotency key was found in the request</td>
</tr>
<tr>
<td><strong>ExpirationInSeconds</strong></td>
<td>3600</td>
<td>The number of seconds to wait before a record is expired</td>
</tr>
<tr>
<td><strong>UseLocalCache</strong></td>
<td><code>false</code></td>
<td>Whether to locally cache idempotency results (LRU cache)</td>
</tr>
<tr>
<td><strong>LocalCacheMaxItems</strong></td>
<td>256</td>
<td>Max number of items to store in local cache</td>
</tr>
<tr>
<td><strong>HashFunction</strong></td>
<td><code>MD5</code></td>
<td>Algorithm to use for calculating hashes, as supported by <code>java.security.MessageDigest</code> (eg. SHA-1, SHA-256, ...)</td>
</tr>
</tbody>
</table>
<p>These features are detailed below.</p>
<h3 id="handling-concurrent-executions-with-the-same-payload">Handling concurrent executions with the same payload<a class="headerlink" href="#handling-concurrent-executions-with-the-same-payload" title="Permanent link">&para;</a></h3>
<p>This utility will throw an <strong><code>IdempotencyAlreadyInProgressException</code></strong> if we receive <strong>multiple invocations with the same payload while the first invocation hasn't completed yet</strong>.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If you receive <code>IdempotencyAlreadyInProgressException</code>, you can safely retry the operation.</p>
</div>
<p>This is a locking mechanism for correctness. Since we don't know the result from the first invocation yet, we can't safely allow another concurrent execution.</p>
<h3 id="using-in-memory-cache">Using in-memory cache<a class="headerlink" href="#using-in-memory-cache" title="Permanent link">&para;</a></h3>
<p><strong>By default, in-memory local caching is disabled</strong>, to avoid using memory in an unpredictable way. </p>
<div class="admonition warning memory configuration of your function">
<p class="admonition-title">Warning</p>
<p>Be sure to configure the Lambda memory according to the number of records and the potential size of each record.</p>
</div>
<p>You can enable it as seen before with:
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Enable local cache</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="w">    </span><span class="n">IdempotencyConfig</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">withUseLocalCache</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
When enabled, we cache a maximum of 256 records in each Lambda execution environment - You can change it with the <strong><code>LocalCacheMaxItems</code></strong> parameter.</p>
<div class="admonition note">
<p class="admonition-title">Note: This in-memory cache is local to each Lambda execution environment</p>
<p>This means it will be effective in cases where your function's concurrency is low in comparison to the number of "retry" invocations with the same payload, because cache might be empty.</p>
</div>
<h3 id="expiring-idempotency-records">Expiring idempotency records<a class="headerlink" href="#expiring-idempotency-records" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By default, we expire idempotency records after <strong>an hour</strong> (3600 seconds).</p>
</div>
<p>In most cases, it is not desirable to store the idempotency records forever. Rather, you want to guarantee that the same payload won't be executed within a period of time.</p>
<p>You can change this window with the <strong><code>ExpirationInSeconds</code></strong> parameter:
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Customizing expiration time</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">IdempotencyConfig</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="na">withExpiration</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="n">ChronoUnit</span><span class="p">.</span><span class="na">MINUTES</span><span class="p">))</span>
<span class="w">    </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
</code></pre></div></td></tr></table></div></p>
<p>Records older than 5 minutes will be marked as expired, and the Lambda handler will be executed normally even if it is invoked with a matching payload.</p>
<div class="admonition note">
<p class="admonition-title">Note: DynamoDB time-to-live field</p>
<p>This utility uses <strong><code>expiration</code></strong> as the TTL field in DynamoDB, as <a href="#required-resources">demonstrated in the SAM example earlier</a>.</p>
</div>
<h3 id="payload-validation">Payload validation<a class="headerlink" href="#payload-validation" title="Permanent link">&para;</a></h3>
<div class="admonition question">
<p class="admonition-title">Question: What if your function is invoked with the same payload except some outer parameters have changed?</p>
<p>Example: A payment transaction for a given productID was requested twice for the same customer, <strong>however the amount to be paid has changed in the second transaction</strong>.</p>
</div>
<p>By default, we will return the same result as it returned before, however in this instance it may be misleading; we provide a fail fast payload validation to address this edge case.</p>
<p>With <strong><code>PayloadValidationJMESPath</code></strong>, you can provide an additional JMESPath expression to specify which part of the event body should be validated against previous idempotent invocations</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:3"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><input id="__tabbed_5_3" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">App.java</label><label for="__tabbed_5_2">Example Event 1</label><label for="__tabbed_5_3">Example Event 2</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="nf">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Idempotency</span><span class="p">.</span><span class="na">config</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="na">withPersistenceStore</span><span class="p">(</span><span class="n">DynamoDBPersistenceStore</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">withTableName</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;TABLE_NAME&quot;</span><span class="p">))</span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="na">withConfig</span><span class="p">(</span><span class="n">IdempotencyConfig</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">withEventKeyJMESPath</span><span class="p">(</span><span class="s">&quot;[userDetail, productId]&quot;</span><span class="p">)</span>
<span class="hll"><span class="w">        </span><span class="p">.</span><span class="na">withPayloadValidationJMESPath</span><span class="p">(</span><span class="s">&quot;amount&quot;</span><span class="p">)</span>
</span><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="na">configure</span><span class="p">();</span>
<span class="p">}</span>

<span class="hll"><span class="nd">@Idempotent</span>
</span><span class="kd">public</span><span class="w"> </span><span class="n">SubscriptionResult</span><span class="w"> </span><span class="nf">handleRequest</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Subscription</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Creating a subscription payment is a side</span>
<span class="w">    </span><span class="c1">// effect of calling this function!</span>
<span class="w">    </span><span class="n">SubscriptionPayment</span><span class="w"> </span><span class="n">payment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">createSubscriptionPayment</span><span class="p">(</span>
<span class="w">      </span><span class="n">input</span><span class="p">.</span><span class="na">getUserDetail</span><span class="p">().</span><span class="na">getUsername</span><span class="p">(),</span>
<span class="w">      </span><span class="n">input</span><span class="p">.</span><span class="na">getProductId</span><span class="p">(),</span>
<span class="hll"><span class="w">      </span><span class="n">input</span><span class="p">.</span><span class="na">getAmount</span><span class="p">()</span>
</span><span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SubscriptionResult</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;success&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">200</span><span class="p">,</span>
<span class="w">        </span><span class="n">payment</span><span class="p">.</span><span class="na">getId</span><span class="p">(),</span>
<span class="hll"><span class="w">        </span><span class="n">payment</span><span class="p">.</span><span class="na">getAmount</span><span class="p">()</span>
</span><span class="w">    </span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;userDetail&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;User1&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;user_email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user@example.com&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;productId&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1500</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;charge_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;subscription&quot;</span><span class="p">,</span>
<span class="hll"><span class="w">    </span><span class="nt">&quot;amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">500</span>
</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;userDetail&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;User1&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;user_email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user@example.com&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;productId&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1500</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;charge_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;subscription&quot;</span><span class="p">,</span>
<span class="hll"><span class="w">    </span><span class="nt">&quot;amount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<p>In this example, the <strong><code>userDetail</code></strong> and <strong><code>productId</code></strong> keys are used as the payload to generate the idempotency key, as per <strong><code>EventKeyJMESPath</code></strong> parameter.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If we try to send the same request but with a different amount, we will raise <strong><code>IdempotencyValidationException</code></strong>.</p>
</div>
<p>Without payload validation, we would have returned the same result as we did for the initial request. Since we're also returning an amount in the response, this could be quite confusing for the client.</p>
<p>By using <strong><code>withPayloadValidationJMESPath("amount")</code></strong>, we prevent this potentially confusing behavior and instead throw an Exception.</p>
<h3 id="making-idempotency-key-required">Making idempotency key required<a class="headerlink" href="#making-idempotency-key-required" title="Permanent link">&para;</a></h3>
<p>If you want to enforce that an idempotency key is required, you can set <strong><code>ThrowOnNoIdempotencyKey</code></strong> to <code>true</code>.</p>
<p>This means that we will throw <strong><code>IdempotencyKeyException</code></strong> if the evaluation of <strong><code>EventKeyJMESPath</code></strong> is <code>null</code>.</p>
<p>When set to <code>false</code> (the default), if the idempotency key is null, then the data is not persisted in the store.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:3"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><input id="__tabbed_6_3" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">App.java</label><label for="__tabbed_6_2">Success Event</label><label for="__tabbed_6_3">Failure Event</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="nf">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Idempotency</span><span class="p">.</span><span class="na">config</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="na">withPersistenceStore</span><span class="p">(</span><span class="n">DynamoDBPersistenceStore</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="na">withTableName</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;TABLE_NAME&quot;</span><span class="p">))</span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="na">withConfig</span><span class="p">(</span><span class="n">IdempotencyConfig</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">        </span><span class="c1">// Requires &quot;user&quot;.&quot;uid&quot; and &quot;orderId&quot; to be present</span>
<span class="w">        </span><span class="p">.</span><span class="na">withEventKeyJMESPath</span><span class="p">(</span><span class="s">&quot;[user.uid, orderId]&quot;</span><span class="p">)</span>
<span class="hll"><span class="w">        </span><span class="p">.</span><span class="na">withThrowOnNoIdempotencyKey</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span><span class="hll"><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
</span><span class="w">    </span><span class="p">.</span><span class="na">configure</span><span class="p">();</span>
<span class="p">}</span>
<span class="hll">
</span><span class="nd">@Idempotent</span>
<span class="kd">public</span><span class="w"> </span><span class="n">OrderResult</span><span class="w"> </span><span class="nf">handleRequest</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Order</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">        </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;BB0D045C-8878-40C8-889E-38B3CB0A61B1&quot;</span><span class="p">,</span>
</span><span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Foo&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="hll"><span class="w">    </span><span class="nt">&quot;orderId&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10000</span>
</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<p>Notice that <code>orderId</code> is now accidentally within <code>user</code> key</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">        </span><span class="nt">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;DE0D000E-1234-10D1-991E-EAC1DD1D52C8&quot;</span><span class="p">,</span>
</span><span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Joe Bloggs&quot;</span><span class="p">,</span>
<span class="hll"><span class="w">        </span><span class="nt">&quot;orderId&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10000</span>
</span><span class="w">    </span><span class="p">},</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h3 id="customizing-dynamodb-configuration">Customizing DynamoDB configuration<a class="headerlink" href="#customizing-dynamodb-configuration" title="Permanent link">&para;</a></h3>
<p>When creating the <code>DynamoDBPersistenceStore</code>, you can set a custom <a href="https://sdk.amazonaws.com/java/api/latest/software/amazon/awssdk/services/dynamodb/DynamoDbClient.html"><code>DynamoDbClient</code></a> if you need to customize the configuration:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:1"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">Custom DynamoDbClient with X-Ray interceptor</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="nf">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">    </span><span class="n">DynamoDbClient</span><span class="w"> </span><span class="n">customClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DynamoDbClient</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
</span><span class="hll"><span class="w">        </span><span class="p">.</span><span class="na">region</span><span class="p">(</span><span class="n">Region</span><span class="p">.</span><span class="na">US_WEST_2</span><span class="p">)</span>
</span><span class="hll"><span class="w">        </span><span class="p">.</span><span class="na">overrideConfiguration</span><span class="p">(</span><span class="n">ClientOverrideConfiguration</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
</span><span class="hll"><span class="w">            </span><span class="p">.</span><span class="na">addExecutionInterceptor</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TracingInterceptor</span><span class="p">())</span>
</span><span class="hll"><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
</span><span class="hll"><span class="w">        </span><span class="p">)</span>
</span><span class="hll"><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</span>
<span class="w">    </span><span class="n">Idempotency</span><span class="p">.</span><span class="na">config</span><span class="p">().</span><span class="na">withPersistenceStore</span><span class="p">(</span>
<span class="w">      </span><span class="n">DynamoDBPersistenceStore</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="na">withTableName</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;TABLE_NAME&quot;</span><span class="p">))</span>
<span class="hll"><span class="w">            </span><span class="p">.</span><span class="na">withDynamoDbClient</span><span class="p">(</span><span class="n">customClient</span><span class="p">)</span>
</span><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
<span class="w">  </span><span class="p">).</span><span class="na">configure</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<div class="admonition info">
<p class="admonition-title">Default configuration is the following:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">DynamoDbClient</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="na">credentialsProvider</span><span class="p">(</span><span class="n">EnvironmentVariableCredentialsProvider</span><span class="p">.</span><span class="na">create</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="na">httpClient</span><span class="p">(</span><span class="n">UrlConnectionHttpClient</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">build</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="na">region</span><span class="p">(</span><span class="n">Region</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="n">AWS_REGION_ENV</span><span class="p">)))</span>
<span class="w">    </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</code></pre></div></td></tr></table></div>
</div>
<h3 id="using-a-dynamodb-table-with-a-composite-primary-key">Using a DynamoDB table with a composite primary key<a class="headerlink" href="#using-a-dynamodb-table-with-a-composite-primary-key" title="Permanent link">&para;</a></h3>
<p>When using a composite primary key table (hash+range key), use <code>SortKeyAttr</code> parameter when initializing your persistence store.</p>
<p>With this setting, we will save the idempotency key in the sort key instead of the primary key. By default, the primary key will now be set to <code>idempotency#{LAMBDA_FUNCTION_NAME}</code>.</p>
<p>You can optionally set a static value for the partition key using the <code>StaticPkValue</code> parameter.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Reusing a DynamoDB table that uses a composite primary key</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="n">Idempotency</span><span class="p">.</span><span class="na">config</span><span class="p">().</span><span class="na">withPersistenceStore</span><span class="p">(</span>
<span class="w">     </span><span class="n">DynamoDBPersistenceStore</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">       </span><span class="p">.</span><span class="na">withTableName</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;TABLE_NAME&quot;</span><span class="p">))</span>
<span class="w">       </span><span class="p">.</span><span class="na">withSortKeyAttr</span><span class="p">(</span><span class="s">&quot;sort_key&quot;</span><span class="p">)</span>
<span class="hll"><span class="w">       </span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
</span><span class="w">   </span><span class="p">.</span><span class="na">configure</span><span class="p">();</span>
</code></pre></div></td></tr></table></div>
<p>Data would then be stored in DynamoDB like this:</p>
<table>
<thead>
<tr>
<th>id</th>
<th>sort_key</th>
<th>expiration</th>
<th>status</th>
<th>data</th>
</tr>
</thead>
<tbody>
<tr>
<td>idempotency#MyLambdaFunction</td>
<td>1e956ef7da78d0cb890be999aecc0c9e</td>
<td>1636549553</td>
<td>COMPLETED</td>
<td>{"id": 12391, "message": "success"}</td>
</tr>
<tr>
<td>idempotency#MyLambdaFunction</td>
<td>2b2cdb5f86361e97b4383087c1ffdf27</td>
<td>1636549571</td>
<td>COMPLETED</td>
<td>{"id": 527212, "message": "success"}</td>
</tr>
<tr>
<td>idempotency#MyLambdaFunction</td>
<td>f091d2527ad1c78f05d54cc3f363be80</td>
<td>1636549585</td>
<td>IN_PROGRESS</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="bring-your-own-persistent-store">Bring your own persistent store<a class="headerlink" href="#bring-your-own-persistent-store" title="Permanent link">&para;</a></h3>
<p>This utility provides an abstract base class, so that you can implement your choice of persistent storage layer.</p>
<p>You can extend the <code>BasePersistenceStore</code> class and implement the abstract methods <code>getRecord</code>, <code>putRecord</code>,
<code>updateRecord</code> and <code>deleteRecord</code>. You can have a look at <a href="https://github.com/aws-powertools/powertools-lambda-java/blob/master/powertools-idempotency/src/main/java/software/amazon/lambda/powertools/idempotency/persistence/DynamoDBPersistenceStore.java"><code>DynamoDBPersistenceStore</code></a> as an implementation reference.</p>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Pay attention to the documentation for each method - you may need to perform additional checks inside these methods to ensure the idempotency guarantees remain intact.</p>
<p>For example, the <code>putRecord</code> method needs to throw an exception if a non-expired record already exists in the data store with a matching key.</p>
</div>
<h2 id="compatibility-with-other-utilities">Compatibility with other utilities<a class="headerlink" href="#compatibility-with-other-utilities" title="Permanent link">&para;</a></h2>
<h3 id="validation-utility">Validation utility<a class="headerlink" href="#validation-utility" title="Permanent link">&para;</a></h3>
<p>The idempotency utility can be used with the <code>@Validation</code> annotation from the <a href="../validation/">validation module</a>. Ensure that idempotency is the innermost annotation.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">Using Idempotency with JSONSchema Validation utility</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="hll"><span class="nd">@Validation</span><span class="p">(</span><span class="n">inboundSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;classpath:/schema_in.json&quot;</span><span class="p">)</span>
</span><span class="hll"><span class="nd">@Idempotent</span>
</span><span class="kd">public</span><span class="w"> </span><span class="n">APIGatewayProxyResponseEvent</span><span class="w"> </span><span class="nf">handleRequest</span><span class="p">(</span><span class="n">APIGatewayProxyRequestEvent</span><span class="w"> </span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition tip">
<p class="admonition-title">Tip: JMESPath Powertools for AWS Lambda (Java) functions are also available</p>
<p>Built-in functions like <code>powertools_json</code>, <code>powertools_base64</code>, <code>powertools_base64_gzip</code> are also available to use in this utility. See <a href="../serialization/">JMESPath Powertools for AWS Lambda (Java) functions</a></p>
</div>
<h2 id="testing-your-code">Testing your code<a class="headerlink" href="#testing-your-code" title="Permanent link">&para;</a></h2>
<p>The idempotency utility provides several routes to test your code.</p>
<h3 id="disabling-the-idempotency-utility">Disabling the idempotency utility<a class="headerlink" href="#disabling-the-idempotency-utility" title="Permanent link">&para;</a></h3>
<p>When testing your code, you may wish to disable the idempotency logic altogether and focus on testing your business logic. To do this, you can set the environment variable <code>POWERTOOLS_IDEMPOTENCY_DISABLED</code> to true. 
If you prefer setting this for specific tests, and are using JUnit 5, you can use <a href="https://junit-pioneer.org/docs/environment-variables/">junit-pioneer</a> library:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:1"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1">MyFunctionTest.java</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@Test</span>
<span class="hll"><span class="nd">@SetEnvironmentVariable</span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Constants</span><span class="p">.</span><span class="na">IDEMPOTENCY_DISABLED_ENV</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">)</span>
</span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testIdempotencyDisabled_shouldJustRunTheFunction</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">MyFunction</span><span class="w"> </span><span class="n">func</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyFunction</span><span class="p">();</span>
<span class="w">    </span><span class="n">func</span><span class="p">.</span><span class="na">handleRequest</span><span class="p">(</span><span class="n">someInput</span><span class="p">,</span><span class="w"> </span><span class="n">mockedContext</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<p>You can also disable the idempotency for all tests using <code>maven-surefire-plugin</code> and adding the environment variable:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="9:1"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="__tabbed_9_1">pom.xml</label></div>
<div class="tabbed-content">
<div class="tabbed-block"></div>
</div>
</div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span>
<span class="normal">8</span>
<span class="normal">9</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nt">&lt;plugin&gt;</span>
<span class="w">    </span><span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
<span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>maven-surefire-plugin<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">    </span><span class="nt">&lt;configuration&gt;</span>
<span class="hll"><span class="w">        </span><span class="nt">&lt;environmentVariables&gt;</span>
</span><span class="hll"><span class="w">            </span><span class="nt">&lt;POWERTOOLS_IDEMPOTENCY_DISABLED&gt;</span>true<span class="nt">&lt;/POWERTOOLS_IDEMPOTENCY_DISABLED&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;/environmentVariables&gt;</span>
</span><span class="w">    </span><span class="nt">&lt;/configuration&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</code></pre></div></td></tr></table></div>
<h3 id="testing-with-dynamodb-local">Testing with DynamoDB Local<a class="headerlink" href="#testing-with-dynamodb-local" title="Permanent link">&para;</a></h3>
<h4 id="unit-tests">Unit tests<a class="headerlink" href="#unit-tests" title="Permanent link">&para;</a></h4>
<p>To unit test your function with DynamoDB Local, you can refer to this guide to <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBLocal.DownloadingAndRunning.html#apache-maven">setup with Maven</a>.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="10:3"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><input id="__tabbed_10_2" name="__tabbed_10" type="radio" /><input id="__tabbed_10_3" name="__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="__tabbed_10_1">pom.xml</label><label for="__tabbed_10_2">AppTest.java</label><label for="__tabbed_10_3">App.java</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nt">&lt;dependencies&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- maven dependency for DynamoDB local --&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="hll"><span class="w">       </span><span class="nt">&lt;groupId&gt;</span>com.amazonaws<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll"><span class="w">       </span><span class="nt">&lt;artifactId&gt;</span>DynamoDBLocal<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll"><span class="w">       </span><span class="nt">&lt;version&gt;</span>[1.12,2.0)<span class="nt">&lt;/version&gt;</span>
</span><span class="w">        </span><span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- Needed when building locally on M1 Mac --&gt;</span>
<span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">        </span><span class="nt">&lt;groupId&gt;</span>io.github.ganadist.sqlite4java<span class="nt">&lt;/groupId&gt;</span>
<span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>libsqlite4java-osx-aarch64<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">        </span><span class="nt">&lt;version&gt;</span>1.0.392<span class="nt">&lt;/version&gt;</span>
<span class="w">        </span><span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<span class="w">        </span><span class="nt">&lt;type&gt;</span>dylib<span class="nt">&lt;/type&gt;</span>
<span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<span class="nt">&lt;/dependencies&gt;</span>
<span class="nt">&lt;repositories&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- custom repository to get the dependency --&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- see https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBLocal.DownloadingAndRunning.html#apache-maven --&gt;</span>
<span class="w">    </span><span class="nt">&lt;repository&gt;</span>
<span class="w">       </span><span class="nt">&lt;id&gt;</span>dynamodb-local-oregon<span class="nt">&lt;/id&gt;</span>
<span class="w">       </span><span class="nt">&lt;name&gt;</span>DynamoDB<span class="w"> </span>Local<span class="w"> </span>Release<span class="w"> </span>Repository<span class="nt">&lt;/name&gt;</span>
<span class="hll"><span class="w">       </span><span class="nt">&lt;url&gt;</span>https://s3-us-west-2.amazonaws.com/dynamodb-local/release<span class="nt">&lt;/url&gt;</span>
</span><span class="hll"><span class="w">    </span><span class="nt">&lt;/repository&gt;</span>
</span><span class="hll"><span class="nt">&lt;/repositories&gt;</span>
</span><span class="nt">&lt;plugins&gt;</span>
<span class="hll"><span class="w">    </span><span class="nt">&lt;plugin&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>maven-surefire-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;version&gt;</span>3.0.0-M5<span class="nt">&lt;/version&gt;</span>
</span><span class="w">        </span><span class="nt">&lt;configuration&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- need sqlite native libs --&gt;</span>
<span class="w">            </span><span class="nt">&lt;systemPropertyVariables&gt;</span>
<span class="w">                </span><span class="nt">&lt;sqlite4java.library.path&gt;</span>${project.build.directory}/native-libs<span class="nt">&lt;/sqlite4java.library.path&gt;</span>
<span class="w">            </span><span class="nt">&lt;/systemPropertyVariables&gt;</span>
<span class="w">            </span><span class="cm">&lt;!-- environment variables for the tests --&gt;</span>
<span class="w">            </span><span class="nt">&lt;environmentVariables&gt;</span>
<span class="w">                </span><span class="nt">&lt;IDEMPOTENCY_TABLE_NAME&gt;</span>idempotency<span class="nt">&lt;/IDEMPOTENCY_TABLE_NAME&gt;</span>
<span class="w">                </span><span class="nt">&lt;AWS_REGION&gt;</span>eu-central-1<span class="nt">&lt;/AWS_REGION&gt;</span>
<span class="w">            </span><span class="nt">&lt;/environmentVariables&gt;</span>
<span class="hll"><span class="w">        </span><span class="nt">&lt;/configuration&gt;</span>
</span><span class="w">    </span><span class="nt">&lt;/plugin&gt;</span>
<span class="w">    </span><span class="nt">&lt;plugin&gt;</span>
<span class="hll"><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>maven-dependency-plugin<span class="nt">&lt;/artifactId&gt;</span>
</span><span class="hll"><span class="w">        </span><span class="nt">&lt;executions&gt;</span>
</span><span class="w">            </span><span class="nt">&lt;execution&gt;</span>
<span class="w">                </span><span class="nt">&lt;id&gt;</span>copy<span class="nt">&lt;/id&gt;</span>
<span class="w">                </span><span class="nt">&lt;phase&gt;</span>test-compile<span class="nt">&lt;/phase&gt;</span>
<span class="w">                </span><span class="nt">&lt;goals&gt;</span>
<span class="w">                    </span><span class="nt">&lt;goal&gt;</span>copy-dependencies<span class="nt">&lt;/goal&gt;</span>
<span class="w">                </span><span class="nt">&lt;/goals&gt;</span>
<span class="w">                </span><span class="nt">&lt;configuration&gt;</span>
<span class="w">                    </span><span class="nt">&lt;includeScope&gt;</span>test<span class="nt">&lt;/includeScope&gt;</span>
<span class="w">                    </span><span class="nt">&lt;includeTypes&gt;</span>so,dll,dylib<span class="nt">&lt;/includeTypes&gt;</span>
<span class="w">                    </span><span class="nt">&lt;outputDirectory&gt;</span>${project.build.directory}/native-libs<span class="nt">&lt;/outputDirectory&gt;</span>
<span class="w">                </span><span class="nt">&lt;/configuration&gt;</span>
<span class="w">            </span><span class="nt">&lt;/execution&gt;</span>
<span class="w">        </span><span class="nt">&lt;/executions&gt;</span>
<span class="w">    </span><span class="nt">&lt;/plugin&gt;</span>
<span class="nt">&lt;/plugins&gt;</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AppTest</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Mock</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">App</span><span class="w"> </span><span class="n">app</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">DynamoDbClient</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@BeforeAll</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setupDynamoLocal</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getFreePort</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// Initialize DynamoDBLocal</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">            </span><span class="n">DynamoDBProxyServer</span><span class="w"> </span><span class="n">dynamoProxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ServerRunner</span><span class="p">.</span><span class="na">createServerFromCommandLineArgs</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span>
</span><span class="hll"><span class="w">                    </span><span class="s">&quot;-inMemory&quot;</span><span class="p">,</span>
</span><span class="hll"><span class="w">                    </span><span class="s">&quot;-port&quot;</span><span class="p">,</span>
</span><span class="hll"><span class="w">                    </span><span class="n">Integer</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
</span><span class="hll"><span class="w">            </span><span class="p">});</span>
</span><span class="hll"><span class="w">            </span><span class="n">dynamoProxy</span><span class="p">.</span><span class="na">start</span><span class="p">();</span>
</span><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Initialize DynamoDBClient</span>
<span class="hll"><span class="w">        </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DynamoDbClient</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
</span><span class="hll"><span class="w">                </span><span class="p">.</span><span class="na">httpClient</span><span class="p">(</span><span class="n">UrlConnectionHttpClient</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">build</span><span class="p">())</span>
</span><span class="hll"><span class="w">                </span><span class="p">.</span><span class="na">region</span><span class="p">(</span><span class="n">Region</span><span class="p">.</span><span class="na">EU_WEST_1</span><span class="p">)</span>
</span><span class="hll"><span class="w">                </span><span class="p">.</span><span class="na">endpointOverride</span><span class="p">(</span><span class="n">URI</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="s">&quot;http://localhost:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">port</span><span class="p">))</span>
</span><span class="hll"><span class="w">                </span><span class="p">.</span><span class="na">credentialsProvider</span><span class="p">(</span><span class="n">StaticCredentialsProvider</span><span class="p">.</span><span class="na">create</span><span class="p">(</span>
</span><span class="hll"><span class="w">                        </span><span class="n">AwsBasicCredentials</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="s">&quot;FAKE&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;FAKE&quot;</span><span class="p">)))</span>
</span><span class="hll"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
</span>
<span class="w">        </span><span class="c1">// create the table (use same table name as in pom.xml)</span>
<span class="w">        </span><span class="n">client</span><span class="p">.</span><span class="na">createTable</span><span class="p">(</span><span class="n">CreateTableRequest</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="hll"><span class="w">                </span><span class="p">.</span><span class="na">tableName</span><span class="p">(</span><span class="s">&quot;idempotency&quot;</span><span class="p">)</span>
</span><span class="w">                </span><span class="p">.</span><span class="na">keySchema</span><span class="p">(</span><span class="n">KeySchemaElement</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">keyType</span><span class="p">(</span><span class="n">KeyType</span><span class="p">.</span><span class="na">HASH</span><span class="p">).</span><span class="na">attributeName</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">())</span>
<span class="w">                </span><span class="p">.</span><span class="na">attributeDefinitions</span><span class="p">(</span>
<span class="w">                        </span><span class="n">AttributeDefinition</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">attributeName</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">).</span><span class="na">attributeType</span><span class="p">(</span><span class="n">ScalarAttributeType</span><span class="p">.</span><span class="na">S</span><span class="p">).</span><span class="na">build</span><span class="p">()</span>
<span class="w">                </span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">billingMode</span><span class="p">(</span><span class="n">BillingMode</span><span class="p">.</span><span class="na">PAY_PER_REQUEST</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getFreePort</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ServerSocket</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ServerSocket</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="p">.</span><span class="na">getLocalPort</span><span class="p">();</span>
<span class="w">            </span><span class="n">socket</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">port</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">IOException</span><span class="w"> </span><span class="n">ioe</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">ioe</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@BeforeEach</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">setUp</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">MockitoAnnotations</span><span class="p">.</span><span class="na">openMocks</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">        </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">App</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Test</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testApp</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">app</span><span class="p">.</span><span class="na">handleRequest</span><span class="p">(...,</span><span class="w"> </span><span class="n">context</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// ... assert</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">App</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">RequestHandler</span><span class="o">&lt;</span><span class="n">Subscription</span><span class="p">,</span><span class="w"> </span><span class="n">SubscriptionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="kd">public</span><span class="w"> </span><span class="nf">App</span><span class="p">(</span><span class="n">DynamoDbClient</span><span class="w"> </span><span class="n">ddbClient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Idempotency</span><span class="p">.</span><span class="na">config</span><span class="p">().</span><span class="na">withPersistenceStore</span><span class="p">(</span>
<span class="w">            </span><span class="n">DynamoDBPersistenceStore</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">                    </span><span class="p">.</span><span class="na">withTableName</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;IDEMPOTENCY_TABLE_NAME&quot;</span><span class="p">))</span>
<span class="w">                    </span><span class="p">.</span><span class="na">withDynamoDbClient</span><span class="p">(</span><span class="n">ddbClient</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
<span class="w">    </span><span class="p">).</span><span class="na">configure</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">public</span><span class="w"> </span><span class="nf">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="p">}</span>

<span class="nd">@Idempotent</span>
<span class="kd">public</span><span class="w"> </span><span class="n">SubscriptionResult</span><span class="w"> </span><span class="nf">handleRequest</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Subscription</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h4 id="sam-local">SAM Local<a class="headerlink" href="#sam-local" title="Permanent link">&para;</a></h4>
<div class="tabbed-set tabbed-alternate" data-tabs="11:3"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><input id="__tabbed_11_2" name="__tabbed_11" type="radio" /><input id="__tabbed_11_3" name="__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="__tabbed_11_1">App.java</label><label for="__tabbed_11_2">shell</label><label for="__tabbed_11_3">env.json</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">App</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">RequestHandler</span><span class="o">&lt;</span><span class="n">Subscription</span><span class="p">,</span><span class="w"> </span><span class="n">SubscriptionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="nf">App</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">DynamoDbClientBuilder</span><span class="w"> </span><span class="n">ddbBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DynamoDbClient</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="w">       </span><span class="p">.</span><span class="na">credentialsProvider</span><span class="p">(</span><span class="n">EnvironmentVariableCredentialsProvider</span><span class="p">.</span><span class="na">create</span><span class="p">())</span>
<span class="w">       </span><span class="p">.</span><span class="na">httpClient</span><span class="p">(</span><span class="n">UrlConnectionHttpClient</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">build</span><span class="p">());</span>

<span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;AWS_SAM_LOCAL&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">      </span><span class="n">ddbBuilder</span><span class="p">.</span><span class="na">endpointOverride</span><span class="p">(</span><span class="n">URI</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="s">&quot;http://dynamo:8000&quot;</span><span class="p">));</span>
</span><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">ddbBuilder</span><span class="p">.</span><span class="na">region</span><span class="p">(</span><span class="n">Region</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;AWS_REGION&quot;</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">Idempotency</span><span class="p">.</span><span class="na">config</span><span class="p">().</span><span class="na">withPersistenceStore</span><span class="p">(</span>
<span class="w">       </span><span class="n">DynamoDBPersistenceStore</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<span class="hll"><span class="w">          </span><span class="p">.</span><span class="na">withTableName</span><span class="p">(</span><span class="n">System</span><span class="p">.</span><span class="na">getenv</span><span class="p">(</span><span class="s">&quot;IDEMPOTENCY_TABLE_NAME&quot;</span><span class="p">))</span>
</span><span class="w">          </span><span class="p">.</span><span class="na">withDynamoDbClient</span><span class="p">(</span><span class="n">ddbBuilder</span><span class="p">.</span><span class="na">build</span><span class="p">())</span>
<span class="w">          </span><span class="p">.</span><span class="na">build</span><span class="p">()</span>
<span class="w">    </span><span class="p">).</span><span class="na">configure</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nd">@Idempotent</span>
<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="n">SubscriptionResult</span><span class="w"> </span><span class="nf">handleRequest</span><span class="p">(</span><span class="kd">final</span><span class="w"> </span><span class="n">Subscription</span><span class="w"> </span><span class="n">event</span><span class="p">,</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># use or create a docker network </span>
<span class="hll">docker<span class="w"> </span>network<span class="w"> </span>inspect<span class="w"> </span>sam-local<span class="w"> </span><span class="o">||</span><span class="w"> </span>docker<span class="w"> </span>network<span class="w"> </span>create<span class="w"> </span>sam-local
</span>
<span class="c1"># start dynamodb-local with docker</span>
docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>--rm<span class="w"> </span>-p<span class="w"> </span><span class="m">8000</span>:8000<span class="w"> </span><span class="se">\</span>
<span class="hll"><span class="w">    </span>--network<span class="w"> </span>sam-local<span class="w"> </span><span class="se">\</span>
</span><span class="hll"><span class="w">    </span>--name<span class="w"> </span>dynamo<span class="w"> </span><span class="se">\</span>
</span><span class="w">    </span>amazon/dynamodb-local

<span class="c1"># create the idempotency table</span>
aws<span class="w"> </span>dynamodb<span class="w"> </span>create-table<span class="w"> </span>
<span class="hll"><span class="w">    </span>--table-name<span class="w"> </span>idempotency<span class="w"> </span><span class="se">\</span>
</span><span class="w">    </span>--attribute-definitions<span class="w"> </span><span class="nv">AttributeName</span><span class="o">=</span>id,AttributeType<span class="o">=</span>S<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--key-schema<span class="w"> </span><span class="nv">AttributeName</span><span class="o">=</span>id,KeyType<span class="o">=</span>HASH<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--billing-mode<span class="w"> </span>PAY_PER_REQUEST<span class="w"> </span><span class="se">\</span>
<span class="hll"><span class="w">    </span>--endpoint-url<span class="w"> </span>http://localhost:8000
</span>
<span class="c1"># invoke the function locally</span>
sam<span class="w"> </span><span class="nb">local</span><span class="w"> </span>invoke<span class="w"> </span>IdempotentFunction<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--event<span class="w"> </span>event.json<span class="w"> </span><span class="se">\</span>
<span class="hll"><span class="w">    </span>--env-vars<span class="w"> </span>env.json<span class="w"> </span><span class="se">\</span>
</span><span class="hll"><span class="w">    </span>--docker-network<span class="w"> </span>sam-local
</span></code></pre></div></td></tr></table></div>
</div>
<div class="tabbed-block">
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;IdempotentFunction&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">        </span><span class="nt">&quot;IDEMPOTENCY_TABLE_NAME&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;idempotency&quot;</span>
</span><span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></td></tr></table></div>
</div>
</div>
</div>
<h2 id="extra-resources">Extra resources<a class="headerlink" href="#extra-resources" title="Permanent link">&para;</a></h2>
<p>If you're interested in a deep dive on how Amazon uses idempotency when building our APIs, check out
<a href="https://aws.amazon.com/builders-library/making-retries-safe-with-idempotent-APIs/">this article</a>.</p>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      2023-07-11
    
  </small>
</div>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2021 Amazon Web Services
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.expand", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.ba449ae6.min.js"></script>
      
        <script src="../../javascript/aws-amplify.min.js"></script>
      
        <script src="../../javascript/extra.js"></script>
      
    
  </body>
</html>